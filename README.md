# Analyzing Malware
    Analysis of the Zeus Banking Trojan

<h2>üë©üèª‚ÄçüíªProject Context</h2>

This project is separated into two parts, the first part of the project we created two virtual machines and a host-only network between the VMs. If you are unaware of what I am referring to, see the first part of the project [here](https://github.com/gaelrivera123/MalwareAnalysisLab/tree/main). When it comes to malware analysis, security practictioners may either used self-hosted labs or cloud-hosted labs, however, in this specific project we will be using self-hosted labs to analyze our sample malware. During this portion of the project, we will utilize popular malware analysis tools and techniques in order to gain further understanding of our malware sample.

<h2>üëæHistory of Zeus Banking Trojan</h2>

- <b>Initially created to extract financial information</b>
- <b>First identified in 2007</b>
  - Since its identification in 2007, there are over 578+ versions of the malware and 36 families
- <b>Code became leaked in 2011 which sparked new versions of the malware but also led to further information on the suspected author, Evgeniy
Mikhailovich Bogachev. He currently has a bounty of $3 million on him set by the FBI</b>
- <b>Methods of Delivery</b>
  - Drive-by downloads: Requires user to visit a site and unsuspectingly download the trojan. Mostly obselete since most websites block malicious downloads by default.
  - Phishing: Social Engineering Method which imitates a legimitate source and preys on unsuspecting users. Main method.
- <b>Trojan's Intentions</b>
  - Steal financial information
  - Add infected machines to a botnet
    - A botnet is a collection of infected machines which are used for mass-attacks, such as spam emails, phishing, DDoS attacks etc.
- <b>Impact</b>
  - Inspired hundreds of variants which utilize leaked source code
  - Led to the infection of millions of computers
  - Over $100 million in damages

<h2>‚úÖProject Prerequisites</h2>

  - <b>Self-hosted lab</b>
    - Cloud-hosted works, but steps may be slightly different
  - <b>Snapshot of base image</b>
  - <b>Internet Connection</b>

<h2>üõ†Ô∏èMalware Analysis Tools Overview</h2>

<h3>Static Tools</h3>

- <b>VirusTotal</b>
  - Analysis tool which reviews malicious files, domains, IPs, and URLs to detect malware
  - Collects results of antivirus services and online security engines which have flagged the malicious file as being a threat.
  - Used to measure its functionality against established security engines.

- <b>PeStudio</b>
  - Statically analyzes sample malware and identifies artifacts of interest</b>
  - Collects metadata:
    - Hashes
    - Header
    - Properties
    - Libraries Used
    - Imports
    - Strings

- <b>Floss</b>
  - Extracts strings from executables
  - Uses advanced static analysis technique to make strings from malware binaries much easier to understand (deobsfucation)

- <b>Capa</b>
  - Detects capabilities of program and outputs what it thinks it may accomplish
  - Rules matched against previously known API calls, strings of interest etc.
  - Behavior mapped to MITRE ATT&CK framework
    - MITRE ATT&CK framework is a guideline for classifying and describing cyberattacks. Essentially the knowledge and base model for cyber adversary behavior.

- <b>Cutter</b>
  - Reverse-Engineering platform
    - Reverse-Engineering refers to the process of deconstruction of a program to better understand its functionalities
  - Used to view assembly-level instructions of a program
    - Assembly language is a low-level programming "language" intended to communicate directly with a computer's hardware. Can reveal how sample malware directly communicates with a computer.
  - View decompiled code
 
<h3>Dynamic Tools</h3>

- <b>INetSim</b>
  - Used to simulate common internet services
  - Used to analyze network behavior changes caused by sample malware

- <b>Wireshark</b>
  - Network packet sniffer and analyzer. Used for troubleshooting a network and analyzing its packets
  - In malware analysis, it can:
    - View ingoing/outgoing network traffic from malicious programs
    - Flag domains or IPs that are being reached out to from the malicious program
   
- <b>Process Monitor (Procmon)</b>
  - Monitors and displays real-time info on Windows filesystem,
  - Captures events from 5 different categories
    - Registry
    - Filesystem
    - Network
    - Processes
    - Profiling Events
  - Used to view malicious changed to filesystem

<h2>ü™úCommon Stages of Malware Analysis</h2>

<b>Static Properties Analysis</b>
- This stage of analysis utilizes the technique of static analysis, which is analyzing malicous files metadata and other information without the need to execute the malware.

<b>Interactive Behavior Analysis</b>
- Here, the technique known as dynamic analysis is used, which involves detonating the malware in a lab to analyze its behavior in real-time.

<b>Fully Automated Analysis</b>
- Malicious files are scanned utilizing automated tools, which in turn can allow you to better understand the sample malware and potential damages it may have to other assets connected to your network.

<b>Reverse-Engineering</b>
- Deconstructing the code after the malicious software has been deployed is highly effective in helping a cybersecurity practioner better understand the effects of malware after it has been fully deployed.

<b>Documenting your Findings</b>
- It is crucial to document your findings of the sample malware, so that in the future you have a greater understanding of how to potentially avoid being infected by malware, and what tactics you may utilize in the event you are infected.

<h2>‚ö†Ô∏èFinal Warnings and Disclaimer:</h2>

- <b>Safety is a requirement when it comes to dealing with malware samples. Always ensure you are following the correct procedures so that you do not risk infecting your host machine. Follow all instructions as stated and remember to use personal judgement when it comes to malware. 
- <b>Disclaimers
  - The project is intended for educational purposes only. I do not condone the use of malware to harm individuals or organizations.
  - I take no responsibility for the infection of malicious software, programs, or files onto any computer or system.

<h2>üö∂Full Project Walkthrough</h2>

<h3>Downloading the trojan</h3>

1. Navigate to VirtualBox and open FlareVM and REMnux.
2. Briefly connect to an internet connection on FlareVM, use NAT or Bridged Adapter
- FlareVM -> Machine -> Settings -> Network -> Attached to: -> NAT or Bridge Adapter -> OK
3. On FlareVM, navigate to Microsoft edge and then proceed to this [website](https://github.com/ytisf/theZoo/tree/master/malware/Binaries/ZeusBankingVersion_26Nov2013)
- Download the ZeusBankingVersion_26Nov2013.zip file, and drag it to your desktop.
- Immediately after download, reconnect to Host-only Adapter to cut off internet access.
4. Before extracting the .exe file from the zip, ensure you are on a host-machine, with no internet access, and are following all safety protocols. Once safety protocols are ensured, you may now:
- Right-click the .zip file -> 7-zip -> Open Archive -> Drag and Drop invoice file -> enter password (infected)
5. We will be building a report as we analyze the sample malware. On your host machine, feel free to use any document editor of your choosing and structure it as recommended here:
<img src="https://i.gyazo.com/42b92d2114502a6e83e9bcbd3adcf045.png" width="350" height="300">

- Note: Always remember to write a report in such a way that you and others who read it will understand it clearly.

<h3>Fingerprinting</h3>

<b>VirusTotal</b>

1. This step will require us to have an internet connection in our VM. If you do not feel comfortable establishing an internet connection with the invoice .exe file installed onto the VM, you do not need to complete this step. But remember so long as you are operating within your VM, you will be safe.
2. Navigate to Google Chrome -> Search VirusTotal -> Choose File -> Select invoice -> Open
<img src="https://i.gyazo.com/92e379f55b4c0313df18e3cfc66ea106.png" width="700" height="500">

- VirusTotal compiles a list of vendors that have previously recognized the file as malicious. It can also provide further information like hashes, and behavior.
3. Reconnect back to your host-only adapter network in your VM.

<b>PeStudio</b>

1. Open PeStudio, and drag and drop the invoice .exe file into it. Take note of the hashes here, you can also view the hashes in VirusTotal.

<b>File Properties</b>

1. Take note of the file name. Here, we can see that the file name uses .pdf.exe which reveals that it was attempting to impersonate a .pdf file when it reality it was a .exe file.

<h3>Basic Static Analysis</h3>

<b>PeStudio</b>
1. Navigate back to PeStudio analysis.
2. Here, we can take note of the names under property and a particular export. Note that the export is spelled incorrectly. 
3. Navigate back to PeStudio and then "Sections". Here, we will take note of the headers, specifically the .text header.
- This is done to compare the sizes between the raw address and virtual address.
- Malware authors will typically pack a file in order to avoid malware analysts studying the file.
- The virtual address will be much higher than the raw address as it is a method of obsfucation for malware authors to essentially hide the raw address, which has the core functionality of the program whereas the virtual address in this specific case would be useless code designed to obfuscate the raw address.
- In this case, the .exe is most likely not packed.
4. Navigate to PeStudio -> Strings
- Here, PeStudio attempts to extract all plaintext and other functionalities the program may employ.
- Take note of the API Calls here, and understand what they are trying to accomplish.
- Note that PeStudio is flagging certain imports as well.
5. Scroll further down. Take note of the random text, followed by KERNEL32
- Likely what is occurring here is the malware author(s) are using further methods of obfuscation to hide what is actually happening to KERNEL32.dll, by instead translating it into random text that means nothing at first glance.
6. Navigate to PeStudio -> Libraries.
- Take note of the .dll(s) that are being used. This can be used to note what the malware may be doing to a system and what further functions within the .dll(s).
7. Navigate back to PeStudio and see the surface-level properties being shown once again.
- Take note of the M Z. This reveals the file is an executable.

<b>Floss</b>

1. Navigate to cmder, this is a more advanced terminal emulator
2. Navigate to Desktop directory, <code>cd Desktop</code>
3. Run <code>ls</code>
4. Run <code>floss invoice_2318362983713_823931342io.pdf.exe > strings.txt</code>
5. View any possible urls or other information using ctrl + f

<b>Capa</b>

1. Navigate to Powershell
2. Navigate to Desktop directory, <code>cd Desktop</code>
3. Run <code>Capa invoice_2318362983713_823931342io.pdf.exe</code>
4. Take note of the ATT&CK Tactic, this can help show what tactics the malware employs.
5. Take note of MBC Objective, this will provide further analysis onto what the program is trying to do in terms of evading malware analysis in this case.
6. Run <code>Capa -vv invoice_2318362983713_823931342io.pdf.exe</code>. Capa will then try and actually find the code that is utilizing the previously mapped techniques.

<h3>Advanced Static Analysis</h3>

<b>Cutter</b>

1. Access internet connection once again. Search "cutter download" and download the file. Extract the .zip onto the desktop, and then run the Cutter.exe file. Run through all the defaults and when it asks for "open file", simple choose the invoice_2318362983713_823931342io.pdf.exe file. Wait for it to run the .exe.
2. Take note of the functions on the left-hand side, and view entry0. If you prefer to see it visually select the graph option down below.

<h3>Basic Dynamic Analysis</h3>

Please ensure you have disabled internet access at this point.

1. Take a snapshot of FlareVM before detonation
3. Navigate to REMnux, and launch <code>inetsim</code> if you have not already.
4. To check and make sure it is running properly, navigate to FlareVM and search something in a web browser. You'll be brought to inetsim webpage.

<b>ProcMon</b>

1. Launch ProcMon.
2. Detonate the malware
3. Take note of the malware deleting itself, and under the process tree we see that the invoice_2318362983713_823931342io.pdf.exe file opened up conhost.exe
4. ProcMon can also filter certain items, feel free to filter and take note of anything that appears interesting.

<b>Wireshark</b>

1. Launch Wireshark > Ethernet > launch invoice_2318362983713_823931342io.pdf.exe again
2. Take note of any interesting data, such as domains

<h3>Conclusion:</h3>

<b>In conclusion, using all of our gathered information, we can conclude a few things:</b>

1. The file invoice_2318362983713_823931342io.pdf.exe has been repeatedly flagged by multiple malware detection services, indicating it is indeed malicious.
2. invoice_2318362983713_823931342io.pdf.exe contains an embedded URL within it, corect.com, however, the URL revealed no interesting information.
3. Reviewing the raw address and virtual address, we can note that the .text file within the invoice_2318362983713_823931342io.pdf.exe contains a smaller virtual address in comparison to the raw address. Malware authors typically "pack" a file by including unnecessary code to further obfuscate the actual malicious code. However, there is no clear indication of packing taking place by simply only viewing the virtual and raw addresses within the .text section.
4. Reviewing the API calls, we can note a few suspicious calls
- GetCapture
- GetWindowTextLength
- GetEnvironmentVariable
- GetLogicalDrives
- GetDriveType
- WriteFile
- FindFirstFile
- GetClipboardOwner
- GetClipboardData
<br>Investigating the API calls and their functions, along with specific calls being used together we can denote that the sample malware is attempting to capture the users data as they perform certain actions. The sample malware is also creating files within filesystem. The sample malware is likely attempting to capture highly sensitive data as the user inputs it into their computer, such as passwords, banking details, and any other SPII. We can likely insinuate keylogging is taking place, which is a method of tracking keystrokes made on a computer. Also, we can note that the sample malware is retrieving computer data, such as drive types and disk drives. Utilizing the previous history of Zeus, along with our current information, we can assume this is being done to further gather information to add the computer to a botnet, however, we cannot be certain these API calls are being used for this specific reason.
5. Reviewing other suspected function calls in conjunction with libraries it is accessing, we can insinuate the sample malware is obfuscating the function calls by generating a random line of text then a library being accessed after. For example:
- BagsSpicDollBikeAzonPoopHamsPyasmap followed by KERNEL32.SetCurrentDirectory
  - Suspected function call is obfuscated with BagsSpicDollBikeAzonPoopHamsPyasmap but is then followed by KERNEL32.SetCurrentDirectory. Likely insinuating our hypothesis of obsfuscation taking place.
- It is worth noting that SHLWAPI.dll, KERNEL32.dll, and USER32.dll are being accessed further indicating malicious activity.
6. 


